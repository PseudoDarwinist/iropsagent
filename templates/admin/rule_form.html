{% extends "base.html" %}

{% block title %}{% if rule %}Edit Rule{% else %}Create Rule{% endif %} - IROPS Agent Admin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    {% if rule %}
                        <i class="bi bi-pencil"></i> Edit Compensation Rule
                    {% else %}
                        <i class="bi bi-plus-circle"></i> Create New Compensation Rule
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="ruleForm">
                    <!-- Rule Name -->
                    <div class="mb-3">
                        <label for="rule_name" class="form-label">Rule Name *</label>
                        <input type="text" 
                               class="form-control" 
                               id="rule_name" 
                               name="rule_name" 
                               value="{{ rule.rule_name if rule else (rule_data.rule_name if rule_data else '') }}" 
                               required 
                               placeholder="e.g., EU261 Cancellation Short Haul">
                        <div class="form-text">A descriptive name for this compensation rule</div>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label for="description" class="form-label">Description *</label>
                        <textarea class="form-control" 
                                  id="description" 
                                  name="description" 
                                  rows="3" 
                                  required 
                                  placeholder="Detailed description of when this rule applies">{{ rule.description if rule else (rule_data.description if rule_data else '') }}</textarea>
                        <div class="form-text">Explain when and how this rule should be applied</div>
                    </div>

                    <!-- Disruption Type -->
                    <div class="mb-3">
                        <label for="disruption_type" class="form-label">Disruption Type *</label>
                        <select class="form-select" id="disruption_type" name="disruption_type" required>
                            <option value="">Select disruption type...</option>
                            {% for dtype in disruption_types %}
                            <option value="{{ dtype }}" 
                                    {% if rule and rule.disruption_type == dtype %}selected{% endif %}
                                    {% if rule_data and rule_data.disruption_type == dtype %}selected{% endif %}>
                                {{ dtype }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Type of flight disruption this rule applies to</div>
                    </div>

                    <!-- Amount -->
                    <div class="mb-3">
                        <label for="amount" class="form-label">Compensation Amount (USD) *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="amount" 
                                   name="amount" 
                                   step="0.01" 
                                   min="0" 
                                   value="{{ rule.amount if rule else (rule_data.amount if rule_data else '') }}" 
                                   required 
                                   placeholder="250.00">
                        </div>
                        <div class="form-text">Base compensation amount in US Dollars</div>
                    </div>

                    <!-- Priority -->
                    <div class="mb-3">
                        <label for="priority" class="form-label">Priority</label>
                        <input type="number" 
                               class="form-control" 
                               id="priority" 
                               name="priority" 
                               min="0" 
                               max="100" 
                               value="{{ rule.priority if rule else (rule_data.priority if rule_data else '0') }}" 
                               placeholder="0">
                        <div class="form-text">Priority level (0-100). Higher numbers take precedence when multiple rules match.</div>
                    </div>

                    <!-- Conditions -->
                    <div class="mb-3">
                        <label for="conditions" class="form-label">Rule Conditions (JSON)</label>
                        <textarea class="form-control conditions-editor" 
                                  id="conditions" 
                                  name="conditions" 
                                  rows="8" 
                                  placeholder='{"flight_distance_km_min": 1500, "booking_class": "Business", "is_international": true}'>{{ rule.conditions|tojson if rule and rule.conditions else (rule_data.conditions|tojson if rule_data and rule_data.conditions else '') }}</textarea>
                        <div class="form-text">
                            JSON object defining when this rule applies. Leave empty for no additional conditions.
                            <br><strong>Common conditions:</strong>
                            <ul class="small mt-2">
                                <li><code>flight_distance_km_min/max</code>: Flight distance in kilometers</li>
                                <li><code>delay_hours_min</code>: Minimum delay hours (for DELAYED type)</li>
                                <li><code>booking_class</code>: Specific booking class (Economy, Business, First)</li>
                                <li><code>is_international</code>: true for international flights</li>
                                <li><code>origin_country</code>: Origin country code (e.g., "US")</li>
                                <li><code>destination_country</code>: Destination country code</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('list_rules') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        <button type="button" class="btn btn-outline-primary" id="validateBtn">
                            <i class="bi bi-check-circle"></i> Validate
                        </button>
                        <button type="submit" class="btn btn-primary">
                            {% if rule %}
                                <i class="bi bi-save"></i> Update Rule
                            {% else %}
                                <i class="bi bi-plus-circle"></i> Create Rule
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Help Panel -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> Rule Configuration Help
                </h6>
            </div>
            <div class="card-body">
                <h6>Disruption Types:</h6>
                <ul class="small">
                    <li><strong>CANCELLED</strong>: Flight cancellations</li>
                    <li><strong>DELAYED</strong>: Significant delays (usually 2+ hours)</li>
                    <li><strong>DIVERTED</strong>: Flight diversions to different airports</li>
                    <li><strong>OVERBOOKED</strong>: Denied boarding due to overbooking</li>
                </ul>

                <h6>Priority System:</h6>
                <p class="small">Higher priority rules take precedence when multiple rules match the same disruption. Use priorities like:</p>
                <ul class="small">
                    <li><strong>90-100</strong>: High priority (regulatory requirements)</li>
                    <li><strong>70-89</strong>: Standard priority</li>
                    <li><strong>50-69</strong>: Low priority</li>
                    <li><strong>0-49</strong>: Fallback rules</li>
                </ul>

                <h6>Condition Examples:</h6>
                <div class="small">
                    <strong>Short-haul flights:</strong>
                    <pre class="rule-conditions">{"flight_distance_km_max": 1500}</pre>
                    
                    <strong>Business class only:</strong>
                    <pre class="rule-conditions">{"booking_class": "Business"}</pre>
                    
                    <strong>Major delays:</strong>
                    <pre class="rule-conditions">{"delay_hours_min": 3.0}</pre>
                    
                    <strong>International flights:</strong>
                    <pre class="rule-conditions">{"is_international": true}</pre>
                </div>
            </div>
        </div>

        <!-- Validation Results -->
        <div class="card mt-3" id="validationCard" style="display: none;">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-check-square"></i> Validation Results
                </h6>
            </div>
            <div class="card-body" id="validationResults">
                <!-- Validation results will be inserted here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('validateBtn').addEventListener('click', function() {
    const form = document.getElementById('ruleForm');
    const formData = new FormData(form);
    
    // Convert form data to JSON
    const ruleData = {};
    for (let [key, value] of formData.entries()) {
        if (key === 'amount' || key === 'priority') {
            ruleData[key] = parseFloat(value) || 0;
        } else if (key === 'conditions') {
            try {
                ruleData[key] = value ? JSON.parse(value) : {};
            } catch (e) {
                ruleData[key] = value;
            }
        } else {
            ruleData[key] = value;
        }
    }
    
    // Send validation request
    fetch('/api/rules/validate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(ruleData)
    })
    .then(response => response.json())
    .then(data => {
        const validationCard = document.getElementById('validationCard');
        const validationResults = document.getElementById('validationResults');
        
        if (data.success) {
            const validation = data.validation;
            let html = '';
            
            if (validation.valid) {
                html += '<div class="alert alert-success small"><i class="bi bi-check-circle"></i> Rule validation passed!</div>';
            } else {
                html += '<div class="alert alert-danger small"><i class="bi bi-x-circle"></i> Rule validation failed!</div>';
            }
            
            if (validation.errors && validation.errors.length > 0) {
                html += '<h6 class="text-danger">Errors:</h6><ul class="small text-danger">';
                validation.errors.forEach(error => {
                    html += `<li>${error}</li>`;
                });
                html += '</ul>';
            }
            
            if (validation.warnings && validation.warnings.length > 0) {
                html += '<h6 class="text-warning">Warnings:</h6><ul class="small text-warning">';
                validation.warnings.forEach(warning => {
                    html += `<li>${warning}</li>`;
                });
                html += '</ul>';
            }
            
            validationResults.innerHTML = html;
            validationCard.style.display = 'block';
        } else {
            validationResults.innerHTML = `<div class="alert alert-danger small">Validation error: ${data.error}</div>`;
            validationCard.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const validationResults = document.getElementById('validationResults');
        validationResults.innerHTML = `<div class="alert alert-danger small">Network error: ${error.message}</div>`;
        document.getElementById('validationCard').style.display = 'block';
    });
});

// Auto-format JSON in conditions field
document.getElementById('conditions').addEventListener('blur', function() {
    try {
        const value = this.value.trim();
        if (value && value !== '{}' && value !== '') {
            const parsed = JSON.parse(value);
            this.value = JSON.stringify(parsed, null, 2);
        }
    } catch (e) {
        // Invalid JSON, leave as is
    }
});
</script>
{% endblock %}